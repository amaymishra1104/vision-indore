import React, { useState, useEffect } from 'react';
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { DEFAULT_MAP_CENTER } from '../config';
import { subscribeToIssues } from '../firebase';
import { analyzeBatch, getRoadHealthStats } from '../api';
import RecentAlerts from './RecentAlerts';
import RoadHealthScore from './RoadHealthScore';
import SimulateDrive from './SimulateDrive';

// Custom marker icons with pulsing animation
const createCustomIcon = (color, icon) => {
  return L.divIcon({
    className: 'custom-marker',
    html: `
      <div class="marker-pulse" style="background: ${color}"></div>
      <div class="marker-pin" style="background: ${color}; box-shadow: 0 0 20px ${color}">
        <span style="font-size: 16px">${icon}</span>
      </div>
    `,
    iconSize: [40, 40],
    iconAnchor: [20, 40],
  });
};

const Dashboard = () => {
  const [issues, setIssues] = useState([]);
  const [healthStats, setHealthStats] = useState(null);
  const [mapCenter] = useState(DEFAULT_MAP_CENTER);
  const [isProcessing, setIsProcessing] = useState(false);

  // Subscribe to real-time Firestore updates
  useEffect(() => {
    console.log('üî• Subscribing to Firestore updates...');
    
    const unsubscribe = subscribeToIssues((updatedIssues) => {
      console.log(`üìä Received ${updatedIssues.length} issues from Firestore`);
      setIssues(updatedIssues);
    });

    // Cleanup subscription on unmount
    return () => {
      console.log('üî• Unsubscribing from Firestore');
      unsubscribe();
    };
  }, []);

  // Fetch health stats periodically
  useEffect(() => {
    const fetchStats = async () => {
      try {
        const response = await getRoadHealthStats();
        setHealthStats(response.stats);
      } catch (error) {
        console.error('Error fetching health stats:', error);
      }
    };

    fetchStats();
    const interval = setInterval(fetchStats, 30000); // Update every 30 seconds

    return () => clearInterval(interval);
  }, []);

  // Handle simulate drive
  const handleSimulateDrive = async (images) => {
    setIsProcessing(true);
    try {
      console.log(`üöó Simulating drive with ${images.length} images...`);
      const response = await analyzeBatch(images);
      console.log('‚úÖ Batch analysis complete:', response);
      
      // Issues will automatically appear via Firestore subscription
      alert(`Drive simulation complete! Detected ${response.results.filter(r => r.issue).length} issues.`);
    } catch (error) {
      console.error('Error during simulate drive:', error);
      alert('Error processing images. Please try again.');
    } finally {
      setIsProcessing(false);
    }
  };

  // Get severity color
  const getSeverityColor = (severity) => {
    if (severity >= 7) return '#EF4444';
    if (severity >= 4) return '#FFBF00';
    return '#39FF14';
  };

  // Get issue icon
  const getIssueIcon = (issueType) => {
    switch (issueType) {
      case 'pothole': return 'üï≥Ô∏è';
      case 'trash': return 'üóëÔ∏è';
      case 'broken_light': return 'üí°';
      default: return '‚ö†Ô∏è';
    }
  };

  return (
    <div className="min-h-screen bg-slate-900 text-white">
      {/* Custom CSS for markers */}
      <style>{`
        .custom-marker {
          background: transparent !important;
          border: none !important;
        }
        
        .marker-pulse {
          position: absolute;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          opacity: 0.6;
          animation: pulse 2s ease-out infinite;
          top: 0;
          left: 0;
        }
        
        @keyframes pulse {
          0% {
            transform: scale(0.8);
            opacity: 0.8;
          }
          50% {
            transform: scale(1.5);
            opacity: 0.3;
          }
          100% {
            transform: scale(2);
            opacity: 0;
          }
        }
        
        .marker-pin {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          border: 3px solid white;
          position: relative;
          z-index: 10;
          margin: 4px;
          transition: transform 0.2s;
        }
        
        .marker-pin:hover {
          transform: scale(1.2);
        }
        
        .leaflet-container {
          background: #0f172a !important;
        }
        
        .leaflet-tile {
          filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }
        
        .leaflet-control-zoom {
          border: none !important;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3) !important;
        }
        
        .leaflet-control-zoom a {
          background: #334155 !important;
          color: #39FF14 !important;
          border: 1px solid #475569 !important;
          font-size: 18px !important;
          font-weight: bold !important;
        }
        
        .leaflet-control-zoom a:hover {
          background: #475569 !important;
        }
        
        .leaflet-popup-content-wrapper {
          background: #1e293b !important;
          color: white !important;
          border: 2px solid #39FF14 !important;
          border-radius: 8px !important;
          box-shadow: 0 0 20px rgba(57, 255, 20, 0.3) !important;
        }
        
        .leaflet-popup-tip {
          background: #1e293b !important;
        }
        
        .leaflet-control-attribution {
          background: rgba(30, 41, 59, 0.8) !important;
          color: #94a3b8 !important;
          font-size: 10px !important;
        }
        
        .leaflet-control-attribution a {
          color: #39FF14 !important;
        }
      `}</style>
      case 'trash':
        return 'üóëÔ∏è';
      case 'broken_light':
        return 'üí°';
      default:
        return '‚ö†Ô∏è';
    }
  };

  return (
    <div className="min-h-screen bg-slate-900 text-white">
      {/* Header */}
      <header className="bg-slate-800 border-b-2 border-neon-green shadow-lg">
        <div className="container mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-neon-green">
                VISION-INDORE
              </h1>
              <p className="text-slate-400 text-sm mt-1">
                Autonomous Urban Governance Command Center
              </p>
            </div>
            <div className="flex items-center space-x-4">
              <div className="text-right">
                <div className="text-sm text-slate-400">Total Issues</div>
                <div className="text-2xl font-bold text-neon-amber">
                  {issues.length}
                </div>
              </div>
              <div className="w-3 h-3 bg-neon-green rounded-full animate-pulse-glow"></div>
              <span className="text-sm text-slate-400">LIVE</span>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <div className="container mx-auto px-6 py-6">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Main Map Section (2/3 width on large screens) */}
          <div className="lg:col-span-2 space-y-6">
            {/* Road Health Score */}
            <RoadHealthScore stats={healthStats} />

            {/* Map */}
            <div className="bg-slate-800 rounded-lg border-2 border-slate-700 overflow-hidden">
              <div className="bg-slate-700 px-4 py-3 border-b border-slate-600">
                <h2 className="text-lg font-semibold text-neon-green flex items-center">
                  <span className="mr-2">üó∫Ô∏è</span>
                  Live Infrastructure Map - Indore
                </h2>
              </div>
              <div className="relative bg-slate-900" style={{ height: '600px' }}>
                {/* OpenStreetMap Embed */}
                <iframe
                  width="100%"
                  height="100%"
                  frameBorder="0"
                  scrolling="no"
                  style={{ border: 0 }}
                  src={`https://www.openstreetmap.org/export/embed.html?bbox=75.7577%2C22.6196%2C75.9577%2C22.8196&layer=mapnik&marker=${mapCenter.lat}%2C${mapCenter.lng}`}
                  title="Indore Map"
                ></iframe>
                
                {/* Issue Markers Overlay */}
                <div className="absolute inset-0 pointer-events-none">
                  {issues.map((issue, idx) => {
                    // Calculate position based on lat/lng relative to map center
                    const latOffset = ((issue.lat - mapCenter.lat) * 3000);
                    const lngOffset = ((issue.lng - mapCenter.lng) * 3000);
                    
                    return (
                      <div
                        key={issue.id}
                        className="absolute pointer-events-auto cursor-pointer"
                        style={{
                          left: `calc(50% + ${lngOffset}px)`,
                          top: `calc(50% - ${latOffset}px)`,
                          transform: 'translate(-50%, -50%)',
                        }}
                        title={`${issue.issue_type} - Severity: ${issue.severity}/10`}
                      >
                        <div className="relative">
                          {/* Pulse ring */}
                          <div
                            className="absolute inset-0 rounded-full animate-ping"
                            style={{
                              backgroundColor: getSeverityColor(issue.severity),
                              opacity: 0.3,
                            }}
                          />
                          
                          {/* Marker */}
                          <div
                            className="w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold shadow-lg border-2 border-white relative z-10"
                            style={{
                              backgroundColor: getSeverityColor(issue.severity),
                              boxShadow: `0 0 20px ${getSeverityColor(issue.severity)}`,
                            }}
                          >
                            {getIssueIcon(issue.issue_type)}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                
                {/* Map Info Overlay */}
                {issues.length === 0 && (
                  <div className="absolute inset-0 flex items-center justify-center bg-slate-900 bg-opacity-50 pointer-events-none">
                    <div className="text-center text-white">
                      <p className="text-2xl mb-2">üìç</p>
                      <p className="text-lg font-semibold">Upload images to see detections on map</p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Simulate Drive Button */}
            <SimulateDrive 
              onSimulate={handleSimulateDrive} 
              isProcessing={isProcessing}
            />
          </div>

          {/* Right Sidebar (1/3 width on large screens) */}
          <div className="space-y-6">
            {/* Recent Alerts */}
            <RecentAlerts 
              issues={issues.slice(0, 10)} 
              getIssueIcon={getIssueIcon}
              getSeverityColor={getSeverityColor}
            />
          </div>
        </div>
      </div>

      {/* Footer */}
      <footer className="bg-slate-800 border-t-2 border-slate-700 mt-12">
        <div className="container mx-auto px-6 py-4 text-center text-slate-400 text-sm">
          <p>Powered by Google Gemini AI ‚Ä¢ OpenStreetMap ‚Ä¢ Firebase</p>
          <p className="mt-1">Building Smarter Cities, One Frame at a Time</p>
        </div>
      </footer>
    </div>
  );
};

export default Dashboard;
